<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Developer Dashboard</title>
  <link rel="stylesheet" href="css/style.css" />
</head>

<body>
  <nav>
    <h1>Mini-Jira | Developer</h1>
    <button onclick="logout()">Logout</button>
  </nav>

  <div class="container">
    <h2>Assigned Bugs</h2>
    <div id="bugList" class="card-list"></div>
  </div>

<script src="js/config.js"></script>
<script src="js/token-parser.js"></script>
<script src="js/auth.js"></script>
<script src="js/roles.js"></script>
<script src="js/api.js"></script>

<script>
// Redirect non-developers
(function () {
  if (getPrimaryRole() !== "developer") {
    alert("Unauthorized");
    logout();
  }
})();

async function loadAssignedBugs() {
  const user = getUserPayload();
  const data = await apiGet("/getBugs?assigned_to=" + user.email);

  const box = document.getElementById("bugList");
  box.innerHTML = "";

  if (!data || !data.items) return;

  data.items.forEach(bug => {
    const div = document.createElement("div");
    div.className = "card";

    div.innerHTML = `
      <h3>${bug.title}</h3>
      <p>${bug.description}</p>
      <span>Status: ${bug.status}</span>
      <button onclick="closeBug('${bug.bug_id}')">Close Bug</button>
    `;

    box.appendChild(div);
  });
}

async function closeBug(id) {
  await apiPost("/closeBug", { bug_id: id });
  alert("Bug Closed!");
  loadAssignedBugs();
}

loadAssignedBugs();
</script>
</body>
</html>
